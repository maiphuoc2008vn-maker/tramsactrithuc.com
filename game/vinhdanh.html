<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vinh Danh - Tr·∫°m S·∫°c Tri Th·ª©c</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="vinhdanh.css">
</head>
<body>

    <header class="main-header">
        <div class="logo-container">
            <h1 class="brand-name">STEAM 12A4</h1>
        </div>
        <nav class="main-nav">
            <a href="hub.html" class="nav-item"><i class="fas fa-arrow-left"></i> Quay l·∫°i</a>
        </nav>
    </header>

    <main class="vinhdanh-container">
        <div class="page-title">
            <h1><i class="fas fa-crown text-warning"></i> B·∫¢NG PHONG TH·∫¶N</h1>
            <p>D·ªØ li·ªáu c·∫≠p nh·∫≠t th·ªùi gian th·ª±c t·ª´ m√°y ch·ªß</p>
        </div>

        <!-- B·ª§C VINH QUANG (TOP 3) -->
        <div class="podium-section" id="podium-area" style="opacity: 0; transition: opacity 1s;">
            <!-- H·∫°ng 2 -->
            <div class="podium-col rank-2">
                <div class="avatar-wrapper"><img id="top2-avatar" src=""><div class="badge-rank silver">2</div></div>
                <div class="podium-stand"><div class="rank-name" id="top2-name">--</div><div class="rank-score" id="top2-score">--</div></div>
            </div>
            <!-- H·∫°ng 1 -->
            <div class="podium-col rank-1">
                <div class="floating-reward"><i class="fas fa-trophy trophy-anim"></i></div>
                <div class="avatar-wrapper"><img id="top1-avatar" src=""><div class="badge-rank gold">1</div></div>
                <div class="podium-stand"><div class="winner-label">üëë H·ªåC B√Å üëë</div><div class="rank-name" id="top1-name">--</div><div class="rank-score" id="top1-score">--</div></div>
            </div>
            <!-- H·∫°ng 3 -->
            <div class="podium-col rank-3">
                <div class="avatar-wrapper"><img id="top3-avatar" src=""><div class="badge-rank bronze">3</div></div>
                <div class="podium-stand"><div class="rank-name" id="top3-name">--</div><div class="rank-score" id="top3-score">--</div></div>
            </div>
        </div>

        <!-- DANH S√ÅCH TOP 4 TR·ªû ƒêI -->
        <section class="leaderboard-section">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>#</th><th>Th√†nh vi√™n</th><th>Danh hi·ªáu</th><th>ƒêi·ªÉm XP</th></tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="4" style="text-align:center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- SCRIPT G·ªåI FIREBASE -->
    <script type="module">
        import { db } from "../firebase-config.js";
        import { collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        async function loadLeaderboard() {
            try {
                // Truy v·∫•n: L·∫•y collection 'users', s·∫Øp x·∫øp gi·∫£m d·∫ßn theo 'score', l·∫•y 50 ng∆∞·ªùi
                const q = query(collection(db, "users"), orderBy("score", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                
                let users = [];
                querySnapshot.forEach((doc) => {
                    users.push(doc.data());
                });

                if(users.length === 0) {
                    document.getElementById('leaderboard-body').innerHTML = "<tr><td colspan='4' style='text-align:center'>Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>";
                    return;
                }

                // C·∫≠p nh·∫≠t Podium
                if(users[0]) updateRank('top1', users[0]);
                if(users[1]) updateRank('top2', users[1]); else document.querySelector('.rank-2').style.visibility = 'hidden';
                if(users[2]) updateRank('top3', users[2]); else document.querySelector('.rank-3').style.visibility = 'hidden';

                // C·∫≠p nh·∫≠t B·∫£ng (T·ª´ ng∆∞·ªùi th·ª© 4 tr·ªü ƒëi)
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = "";
                
                for (let i = 3; i < users.length; i++) {
                    const u = users[i];
                    let row = `
                        <tr>
                            <td>${i + 1}</td>
                            <td style="display:flex; align-items:center; gap:10px;">
                                <img src="${u.avatar}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                                ${u.username}
                            </td>
                            <td><span class="tag-title">${u.title || "Th√†nh vi√™n"}</span></td>
                            <td>${u.score.toLocaleString()} XP</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
                
                // Hi·ªán giao di·ªán
                document.getElementById('podium-area').style.opacity = 1;

            } catch (err) {
                console.error(err);
                document.getElementById('leaderboard-body').innerHTML = "<tr><td colspan='4' style='text-align:center; color:red'>L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>";
            }
        }

        function updateRank(id, user) {
            document.getElementById(`${id}-name`).innerText = user.username;
            document.getElementById(`${id}-score`).innerText = user.score.toLocaleString();
            document.getElementById(`${id}-avatar`).src = user.avatar;
        }

        loadLeaderboard();
    </script>
</body>
</html>
